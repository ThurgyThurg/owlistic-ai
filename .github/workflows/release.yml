name: On release

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  backend:
    name: Backend Build and Push
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # Set up Go environment
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.23"

      # Build Golang binary
      - name: Build Golang Binary
        run: |
          cd src/backend
          go build -o thinkstack ./cmd/main.go

      # Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build Docker Image
      - name: Build Backend Docker Image
        uses: docker/build-push-action@v5
        with:
          push: true
          context: src/backend
          platforms: linux/amd64
          file: src/backend/Dockerfile
          tags: thinkstack:latest-amd64,thinkstack:${{ github.ref_name }}-amd64
          cache-from: type=registry,ref=thinkstack:${{ github.ref_name }}-amd64

  frontend:
    name: Frontend Build and Push
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          persist-credentials: false


      # Set up Flutter environment
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # Install Dependencies
      - name: Install Flutter Dependencies
        run: |
          cd src/frontend
          flutter pub get

      # Build Flutter Apps for Multiple Platforms
      - name: Build Client Apps
        run: |
          cd src/frontend

          # Configure Flutter for web
          flutter config --enable-web
          # --enable-android --enable-ios --enable-macos-desktop  --enable-linux-desktop --enable-linux-desktop

          # Get Flutter packages
          flutter pub get

          # Initialize web project (creates index.html if missing)
          flutter create --platforms=web . #,android,ios,macos,linux
          
          # Build web app
          flutter build web --release

          # Build Android app
          # flutter build apk --release

          # Build iOS app
          # flutter build ios --release

          # Build macOS app
          # flutter build macos --release

          # Build macOS app
          # flutter build linux --release

      # Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build Docker Image
      - name: Build Frontend Docker Image
        uses: docker/build-push-action@v5
        with:
          push: true
          context: src/frontend
          platforms: linux/amd64
          file: src/frontend/Dockerfile
          tags: thinkstack-ui:latest-amd64,thinkstack-ui:${{ github.ref_name }}-amd64
          cache-from: type=registry,ref=${{ github.ref_name }}-amd64
