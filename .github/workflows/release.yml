name: artifacts-release

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  server-binary:
    name: Server binary Package and Archive
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      # Set up Go environment
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.23"

      # Build Golang binary
      - name: Build Golang Binary
        run: |
          cd src/backend
          go build -o owlistic ./cmd/main.go
          
      # Archive Go binary as artifact
      - name: Archive Go Binary
        uses: actions/upload-artifact@v4
        with:
          name: Server Binary
          path: src/backend/owlistic
          retention-days: 7
          if-no-files-found: error

  retag-server-images:
    name: Retag Server Docker Images
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      # Checkout code to get the commit SHA
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      # Get the commit SHA
      - name: Get commit SHA
        id: get-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      # Log in to Github Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      # Get the version tag without the 'v' prefix
      - name: Extract version tag
        id: get-tag
        run: echo "tag=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      # Retag and push ARM64 server image
      - name: Retag and push ARM64 server image
        run: |
          SOURCE_IMAGE="ghcr.io/${{ github.repository }}:${{ steps.get-sha.outputs.sha }}"
          VERSION_TAG="ghcr.io/${{ github.repository }}:${{ steps.get-tag.outputs.tag }}"
          LATEST_TAG="ghcr.io/${{ github.repository }}:latest"
          
          echo "Pulling source image: ${SOURCE_IMAGE}"
          docker pull ${SOURCE_IMAGE}
          
          echo "Tagging with version: ${VERSION_TAG}"
          docker tag ${SOURCE_IMAGE} ${VERSION_TAG}
          
          echo "Tagging as latest: ${LATEST_TAG}"
          docker tag ${SOURCE_IMAGE} ${LATEST_TAG}
          
          echo "Pushing tags"
          docker push ${VERSION_TAG}
          docker push ${LATEST_TAG}

      # Retag and push AMD64 server image
      - name: Retag and push AMD64 server image
        run: |
          SOURCE_IMAGE="ghcr.io/${{ github.repository }}:${{ steps.get-sha.outputs.sha }}-amd64"
          VERSION_TAG="ghcr.io/${{ github.repository }}:${{ steps.get-tag.outputs.tag }}-amd64"
          
          echo "Pulling source image: ${SOURCE_IMAGE}"
          docker pull ${SOURCE_IMAGE}
          
          echo "Tagging with version: ${VERSION_TAG}"
          docker tag ${SOURCE_IMAGE} ${VERSION_TAG}
          
          echo "Pushing tag"
          docker push ${VERSION_TAG}

  retag-frontend-images:
    name: Retag Frontend Docker Images
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      # Checkout code to get the commit SHA
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      # Get the commit SHA
      - name: Get commit SHA
        id: get-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      # Log in to Github Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      # Get the version tag without the 'v' prefix
      - name: Extract version tag
        id: get-tag
        run: echo "tag=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      # Retag and push ARM64 frontend image
      - name: Retag and push ARM64 frontend image
        run: |
          SOURCE_IMAGE="ghcr.io/${{ github.repository }}-app:${{ steps.get-sha.outputs.sha }}"
          VERSION_TAG="ghcr.io/${{ github.repository }}-app:${{ steps.get-tag.outputs.tag }}"
          LATEST_TAG="ghcr.io/${{ github.repository }}-app:latest"
          
          echo "Pulling source image: ${SOURCE_IMAGE}"
          docker pull ${SOURCE_IMAGE}
          
          echo "Tagging with version: ${VERSION_TAG}"
          docker tag ${SOURCE_IMAGE} ${VERSION_TAG}
          
          echo "Tagging as latest: ${LATEST_TAG}"
          docker tag ${SOURCE_IMAGE} ${LATEST_TAG}
          
          echo "Pushing tags"
          docker push ${VERSION_TAG}
          docker push ${LATEST_TAG}

      # Retag and push AMD64 frontend image
      - name: Retag and push AMD64 frontend image
        run: |
          SOURCE_IMAGE="ghcr.io/${{ github.repository }}-app:${{ steps.get-sha.outputs.sha }}-amd64"
          VERSION_TAG="ghcr.io/${{ github.repository }}-app:${{ steps.get-tag.outputs.tag }}-amd64"
          
          echo "Pulling source image: ${SOURCE_IMAGE}"
          docker pull ${SOURCE_IMAGE}
          
          echo "Tagging with version: ${VERSION_TAG}"
          docker tag ${SOURCE_IMAGE} ${VERSION_TAG}
          
          echo "Pushing tag"
          docker push ${VERSION_TAG}
          
  frontend-package:
    name: Frontend Package and Archive
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # Setup Flutter environment
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # Install Dependencies
      - name: Install Flutter Dependencies
        run: |
          cd src/frontend
          flutter pub get

      # Build Flutter Apps for Multiple Platforms
      - name: Build Client Apps
        run: |
          cd src/frontend

          # Configure Flutter for web
          flutter config --enable-web
          # --enable-android --enable-ios --enable-macos-desktop  --enable-linux-desktop --enable-linux-desktop

          # Get Flutter packages
          flutter pub get

          # Initialize web project (creates index.html if missing)
          flutter create --platforms=web . #,android,ios,macos,linux
          
          # Build web app
          flutter build web --release

          # Build Android app
          # flutter build apk --release

          # Build iOS app
          # flutter build ios --release

          # Build macOS app
          # flutter build macos --release

          # Build macOS app
          # flutter build linux --release
          
      # Archive Flutter web build as artifact
      - name: Archive Web App
        uses: actions/upload-artifact@v4
        with:
          name: Web App
          path: src/frontend/web
          retention-days: 7
          if-no-files-found: error
